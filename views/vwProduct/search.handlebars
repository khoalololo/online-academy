<h5 class="p-4 bg-gray-200 font-semibold rounded-t-md text-gray-800 text-lg">
  Search Courses
</h5>

<div class="p-6">
  <form method="GET" action="/products/search" class="mb-8 p-4 bg-white rounded-lg shadow-sm border">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label for="q" class="block text-sm font-medium text-gray-700">Search for:</label>
        <input type="text" name="q" id="q" value="{{searchParams.q}}" placeholder="e.g. 'Python' or 'React'"
               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
      </div>
      
      <div>
        <label for="catid" class="block text-sm font-medium text-gray-700">In Category:</label>
        <select name="catid" id="catid"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
          <option value="">All Categories</option>
          {{#each allCategories}}
            <option value="{{this.id}}" class="font-bold" {{#if (eq this.id ../searchParams.catid)}}selected{{/if}}>
              {{this.name}}
            </option>
            {{#each this.subcategories}}
              <option value="{{this.id}}" {{#if (eq this.id ../../searchParams.catid)}}selected{{/if}}>
                &nbsp; &nbsp; &bull; {{this.name}}
              </option>
            {{/each}}
          {{/each}}
        </select>
      </div>

      <div>
        <label for="sortBy" class="block text-sm font-medium text-gray-700">Sort by:</label>
        <select name="sortBy" id="sortBy"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
          <option value="relevance" {{#if (eq searchParams.sortBy "relevance")}}selected{{/if}}>Relevance</option>
          <option value="newest" {{#if (eq searchParams.sortBy "newest")}}selected{{/if}}>Newest</option>
          <option value="popular" {{#if (eq searchParams.sortBy "popular")}}selected{{/if}}>Most Popular</option>
          <option value="rating" {{#if (eq searchParams.sortBy "rating")}}selected{{/if}}>Highest Rating</option>
          <option value="price_asc" {{#if (eq searchParams.sortBy "price_asc")}}selected{{/if}}>Price: Low to High</option>
        </select>
      </div>
    </div>
    <div class="mt-4 text-right">
      <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
        Search
      </button>
    </div>
  </form>

  {{#if courses.length}}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {{#each courses}}
        <div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col group relative">
        {{!-- Badges for Best Seller & New - Stacked Vertically --}}
        {{#if this.isBestseller}}
            <span class="absolute top-2 left-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full z-10">Best Seller</span>
        {{/if}}
        {{#if this.isNew}}
            <span class="absolute {{#if this.isBestseller}}top-10{{else}}top-2{{/if}} left-2 bg-green-400 text-green-900 text-xs font-bold px-2 py-1 rounded-full z-10">New</span>
        {{/if}}

        <a href="/products/{{this.proid}}" class="block">
            <img class="w-full h-48 object-cover" 
                 src="{{#if this.thumbnail}}{{this.thumbnail}}{{else}}/static/images/default-course.png{{/if}}" 
                 alt="{{this.proname}}">
        </a>
        <div class="p-4 flex flex-col flex-grow">
            <p class="text-sm text-indigo-600 font-semibold mb-1">{{this.category_name}}</p>
            <h3 class="text-lg font-bold text-gray-900 mb-2 truncate group-hover:text-indigo-600 transition-colors">
            <a href="/products/{{this.proid}}">{{this.proname}}</a>
            </h3>
            <p class="text-xs text-gray-600 mb-3">By {{this.instructor_name}}</p>
            
            <div class="flex items-center mb-4">
            <span class="text-sm font-bold text-yellow-500 mr-1">{{toFixed this.average_rating 1}}</span>
            <div class="flex items-center text-yellow-400 text-sm">
                {{{stars this.average_rating}}}
            </div>
            <span class="text-xs text-gray-500 ml-2">({{formatNumber this.rating_count}})</span>
            </div>

            <div class="mt-auto flex justify-end items-center">
            {{#if this.promo_price}}
                <span class="text-lg font-bold text-red-600">${{formatNumber this.promo_price}}</span>
                <span class="text-sm text-gray-500 line-through ml-2">${{formatNumber this.price}}</span>
            {{else}}
                <span class="text-lg font-bold text-gray-800">${{formatNumber this.price}}</span>
            {{/if}}
            </div>
        </div>
        </div>
        {{/each}}
    </div>

    {{!-- PAGINATION --}}
    {{#with pagination}}
    {{#if (gt totalPages 1)}}
    <nav aria-label="Page navigation" class="mt-10 flex justify-center">
        <ul class="inline-flex items-center space-x-2">
        <li>
            <a href="{{#if hasPrev}}/products/search?{{buildQueryString ../searchParams 'page' (sub page 1)}}{{else}}#{{/if}}"
            class="px-3 py-2 rounded-lg border text-sm font-medium {{#if hasPrev}}text-indigo-700 bg-white hover:bg-gray-100 border-gray-300{{else}}text-gray-400 bg-gray-100 border-gray-200 cursor-not-allowed{{/if}}">
            ‹ Prev
            </a>
        </li>
        {{#each pageNumbers}}
        <li>
            <a href="/products/search?{{buildQueryString ../../searchParams 'page' this.value}}"
            class="px-3 py-2 rounded-lg border text-sm font-medium {{#if this.isCurrent}}bg-indigo-600 text-white border-indigo-600{{else}}text-indigo-700 bg-white hover:bg-gray-100 border-gray-300{{/if}}">
            {{this.value}}
            </a>
        </li>
        {{/each}}
        <li>
            <a href="{{#if hasNext}}/products/search?{{buildQueryString ../searchParams 'page' (add page 1)}}{{else}}#{{/if}}"
            class="px-3 py-2 rounded-lg border text-sm font-medium {{#if hasNext}}text-indigo-700 bg-white hover:bg-gray-100 border-gray-300{{else}}text-gray-400 bg-gray-100 border-gray-200 cursor-not-allowed{{/if}}">
            Next ›
            </a>
        </li>
        </ul>
    </nav>
    {{/if}}
    {{/with}}

    {{else}}
    <p class="text-gray-500 text-center text-lg py-12">No courses matched your search.</p>
    {{/if}}
</div>