<div class="max-w-7xl mx-auto">
    <!-- Breadcrumb Navigation -->
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2 text-gray-600">
            <li><a href="/" class="hover:text-indigo-600">Home</a></li>
            <li><span class="mx-2">/</span></li>
            {{#if course.parent_category_name}}
                <li><a href="/products/byCat?catid={{course.parent_catid}}" class="hover:text-indigo-600">{{course.parent_category_name}}</a></li>
                <li><span class="mx-2">/</span></li>
            {{/if}}
            <li><a href="/products/byCat?catid={{course.catid}}" class="hover:text-indigo-600">{{course.category_name}}</a></li>
            <li><span class="mx-2">/</span></li>
            <li class="text-gray-900 font-semibold">{{course.proname}}</li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content (Left Side) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Course Header -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="relative h-80 bg-gradient-to-br from-indigo-600 to-purple-700">
                    <img src="https://picsum.photos/800/400?random={{course.proid}}" 
                         alt="{{course.proname}}" 
                         class="w-full h-full object-cover opacity-80">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    <div class="absolute bottom-0 left-0 right-0 p-8 text-white">
                        <span class="inline-block bg-yellow-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-full mb-3">
                            {{course.category_name}}
                        </span>
                        <h1 class="text-4xl font-extrabold mb-2">{{course.proname}}</h1>
                        <p class="text-lg opacity-90">{{course.tinydes}}</p>
                    </div>
                </div>

                <div class="p-6 border-b">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                {{{stars rating.average}}}
                            </div>
                            <span class="text-sm text-gray-600">
                                <span class="font-bold text-gray-900">{{rating.average}}</span> 
                                ({{formatNumber rating.count}} {{#if (gt rating.count 1)}}ratings{{else}}rating{{/if}})
                            </span>
                            <span class="text-sm text-gray-600">
                                <svg class="inline w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                </svg>
                                {{formatNumber studentCount}} students
                            </span>
                            <span class="text-sm text-gray-600">
                                <svg class="inline w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                </svg>
                                {{formatNumber course.views}} views
                            </span>
                        </div>
                        <div class="text-sm text-gray-500">
                            Last updated: {{course.last_updated}}
                        </div>
                    </div>
                </div>
            </div>

            <!-- What You'll Learn -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">What You'll Learn</h2>
                <div class="prose max-w-none text-gray-700 leading-relaxed">
                    {{{course.fulldes}}}
                </div>
            </div>

            <!-- Course Content/Curriculum -->
            {{#if lessons.length}}
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Course Content</h2>
                <div class="mb-4 text-sm text-gray-600">
                    <span class="font-semibold">{{lessonCount}}</span> lessons â€¢
                    <span class="font-semibold">{{totalDuration}}</span> minutes total length
                </div>
                <div class="space-y-2">
                    {{#each lessons}}
                    <div class="border border-gray-200 rounded-lg hover:border-indigo-300 transition-colors">
                        <div class="p-4 flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div>
                                        <h4 class="font-semibold text-gray-900">{{this.title}}</h4>
                                        {{#if this.description}}
                                            <p class="text-sm text-gray-600 mt-1">{{this.description}}</p>
                                        {{/if}}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                {{#if this.is_preview}}
                                    <span class="text-xs bg-green-100 text-green-800 font-semibold px-2 py-1 rounded">Preview</span>
                                {{/if}}
                                <span class="text-sm text-gray-500">{{div this.duration 60}} min</span>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/if}}

            <!-- Reviews Section -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Student Feedback</h2>
                
                <!-- Rating Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 pb-8 border-b">
                    <div class="text-center">
                        <div class="text-6xl font-extrabold text-gray-900 mb-2">{{rating.average}}</div>
                        <div class="flex items-center justify-center mb-2">
                            {{{stars rating.average}}}
                        </div>
                        <p class="text-gray-600">Course Rating</p>
                    </div>
                    <div class="space-y-2">
                        {{#each ratingDistribution}}
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-semibold text-gray-700 w-12">{{this.rating}} star</span>
                            <div class="flex-1 bg-gray-200 rounded-full h-3">
                                <div class="bg-yellow-400 h-3 rounded-full transition-all" 
                                     style="width: {{div (mul this.count 100) ../rating.count}}%"></div>
                            </div>
                            <span class="text-sm text-gray-600 w-12 text-right">{{this.count}}</span>
                        </div>
                        {{/each}}
                    </div>
                </div>

                <!-- Reviews List -->
                {{#if reviews.length}}
                <div class="space-y-6">
                    {{#each reviews}}
                    <div class="border-b border-gray-200 pb-6 last:border-0">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                    {{substring this.user_name 0 1}}
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-semibold text-gray-900">{{this.user_name}}</h4>
                                    <span class="text-xs text-gray-500">{{this.created_at}}</span>
                                </div>
                                <div class="flex items-center mb-2">
                                    {{{stars this.rating}}}
                                </div>
                                <p class="text-gray-700 leading-relaxed">{{this.comment}}</p>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <div class="text-center py-8 text-gray-500">
                    <p>No reviews yet. Be the first to review this course!</p>
                </div>
                {{/if}}
            </div>

            <!-- Instructor Info -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Instructor</h2>
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                            {{substring course.instructor_name 0 1}}
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900">{{course.instructor_name}}</h3>
                        <p class="text-gray-600 mt-1">{{course.instructor_email}}</p>
                        <p class="text-gray-700 mt-3">
                            Professional instructor with years of experience in teaching and industry practice.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Related Courses -->
            {{#if relatedCourses.length}}
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Students Also Bought</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {{#each relatedCourses}}
                    <a href="/products/{{this.proid}}" class="group flex bg-gray-50 rounded-lg overflow-hidden hover:shadow-lg transition-all">
                        <img src="https://picsum.photos/200/150?random={{this.proid}}" 
                             alt="{{this.proname}}" 
                             class="w-32 h-24 object-cover">
                        <div class="flex-1 p-3">
                            <h4 class="font-semibold text-sm text-gray-900 group-hover:text-indigo-600 transition-colors line-clamp-2">
                                {{this.proname}}
                            </h4>
                            <p class="text-xs text-gray-600 mt-1">{{this.instructor_name}}</p>
                            <div class="flex items-center mt-1">
                                {{{stars this.average_rating}}}
                                <span class="text-xs text-gray-600 ml-1">({{this.rating_count}})</span>
                            </div>
                            <div class="flex items-center mt-2">
                                <span class="text-sm font-bold text-green-600">${{formatNumber this.price}}</span>
                            </div>
                        </div>
                    </a>
                    {{/each}}
                </div>
            </div>
            {{/if}}
        </div>

        <!-- Sidebar (Right Side) -->
        <div class="lg:col-span-1">
            <div class="sticky top-20">
                <!-- Price Card -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border-2 border-gray-200">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            {{#if course.promo_price}}
                                <div class="flex items-baseline justify-center space-x-2">
                                    <span class="text-4xl font-extrabold text-red-600">${{formatNumber course.promo_price}}</span>
                                    <span class="text-xl text-gray-500 line-through">${{formatNumber course.price}}</span>
                                </div>
                                <div class="mt-2">
                                    <span class="inline-block bg-red-100 text-red-800 text-xs font-semibold px-3 py-1 rounded-full">
                                        {{percentage course.price course.promo_price}}% OFF
                                    </span>
                                </div>
                            {{else}}
                                <span class="text-4xl font-extrabold text-gray-900">${{formatNumber course.price}}</span>
                            {{/if}}
                        </div>

                        <!-- Action Buttons -->
                        {{#if isAuthenticated}}
                            {{#if isEnrolled}}
                                <a href="/student/learn/{{course.proid}}" 
                                   class="block w-full px-6 py-3 bg-green-600 text-white text-center font-bold rounded-lg hover:bg-green-700 transition-colors mb-3">
                                    Go to Course
                                </a>
                            {{else}}
                                <button type="button" 
                                        class="w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors mb-3"
                                        onclick="enrollCourse({{course.proid}})">
                                    Enroll Now
                                </button>
                            {{/if}}

                            <!-- Watchlist Button -->
                            {{#if isInWatchlist}}
                                <button type="button" 
                                        class="w-full px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition-colors flex items-center justify-center"
                                        onclick="removeFromWatchlist({{course.proid}})">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    In Watchlist
                                </button>
                            {{else}}
                                <button type="button" 
                                        class="w-full px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors flex items-center justify-center"
                                        onclick="addToWatchlist({{course.proid}})">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                    </svg>
                                    Add to Watchlist
                                </button>
                            {{/if}}
                        {{else}}
                            <a href="/account/signin?retUrl=/products/{{course.proid}}" 
                               class="block w-full px-6 py-3 bg-indigo-600 text-white text-center font-bold rounded-lg hover:bg-indigo-700 transition-colors mb-3">
                                Sign In to Enroll
                            </a>
                        {{/if}}

                        <!-- Course Info -->
                        <div class="mt-6 pt-6 border-t space-y-3 text-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Status</span>
                                <span class="font-semibold {{#if course.is_completed}}text-green-600{{else}}text-yellow-600{{/if}}">
                                    {{#if course.is_completed}}Completed{{else}}In Progress{{/if}}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Language</span>
                                <span class="font-semibold text-gray-900">English</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Last Updated</span>
                                <span class="font-semibold text-gray-900">{{course.last_updated}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{#section 'js'}}
<script>
async function enrollCourse(proid) {
    try {
        const response = await fetch(`/student/enroll/${proid}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (response.ok) {
            Swal.fire({
                title: 'Success!',
                text: 'Successfully enrolled in the course!',
                icon: 'success',
                confirmButtonColor: '#4F46E5'
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                title: 'Error!',
                text: data.message || 'Failed to enroll in course.',
                icon: 'error',
                confirmButtonColor: '#4F46E5'
            });
        }
    } catch (error) {
        Swal.fire({
            title: 'Error!',
            text: 'An error occurred. Please try again.',
            icon: 'error',
            confirmButtonColor: '#4F46E5'
        });
    }
}

async function addToWatchlist(proid) {
    try {
        const response = await fetch(`/student/watchlist/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ proid })
        });

        const data = await response.json();

        if (response.ok) {
            Swal.fire({
                title: 'Added!',
                text: 'Course added to your watchlist!',
                icon: 'success',
                confirmButtonColor: '#4F46E5',
                timer: 1500
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                title: 'Error!',
                text: data.message || 'Failed to add to watchlist.',
                icon: 'error',
                confirmButtonColor: '#4F46E5'
            });
        }
    } catch (error) {
        Swal.fire({
            title: 'Error!',
            text: 'An error occurred. Please try again.',
            icon: 'error',
            confirmButtonColor: '#4F46E5'
        });
    }
}

async function removeFromWatchlist(proid) {
    try {
        const response = await fetch(`/student/watchlist/remove`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ proid })
        });

        const data = await response.json();

        if (response.ok) {
            Swal.fire({
                title: 'Removed!',
                text: 'Course removed from your watchlist.',
                icon: 'success',
                confirmButtonColor: '#4F46E5',
                timer: 1500
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                title: 'Error!',
                text: data.message || 'Failed to remove from watchlist.',
                icon: 'error',
                confirmButtonColor: '#4F46E5'
            });
        }
    } catch (error) {
        Swal.fire({
            title: 'Error!',
            text: 'An error occurred. Please try again.',
            icon: 'error',
            confirmButtonColor: '#4F46E5'
        });
    }
}
</script>
{{/section}}